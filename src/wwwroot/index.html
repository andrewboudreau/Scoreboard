<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDL Scoreboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="scoreboard">
        <div class="scores">
            <div class="team">
                <div class="team-name" contenteditable="true">BLACK</div>
                <div class="score" id="score-team1">0</div>
            </div>
            <div class="team">
                <div class="team-name" contenteditable="true">WHITE</div>
                <div class="score" id="score-team2">0</div>
            </div>
        </div>
        <div class="timer-container">
            <div class="timer" id="timer">10:00</div>
            <div class="score-history" id="score-history"></div>
        </div>
        <div class="control-buttons">
            <button id="settings-btn" class="control-btn">
                <img src="icons/settings.svg" alt="Settings Icon" width="24" height="24">
            </button>
            <button id="fullscreen-btn" class="control-btn">
                <img src="icons/fullscreen.svg" alt="Fullscreen Icon" width="24" height="24">
            </button>
        </div>

        <div id="settings-panel" class="settings-panel">
            <div class="settings-group">
                <label for="timer-minutes">Timer (minutes)</label>
                <input type="number" id="timer-minutes" min="1" max="60" value="10">
                <button id="set-timer-btn">Set Timer</button>
            </div>
            <div class="settings-group">
                <label for="team1-name">Teams</label>
                <input type="text" id="team1-name" value="BLACK">
                <input type="text" id="team2-name" value="WHITE">
                <button id="set-team-btn">Update</button>
            </div>
            <div class="settings-group">
                <button id="reset-history-btn">Reset Score History</button>
                <button id="reset-scores-btn">Reset Scores</button>
                <button id="test-buzzer-btn">Test Buzzer Sound</button>
            </div>
            <div class="settings-group">
                <label for="score-font-size">Score Font Size: <span id="score-font-size-value">10</span>rem</label>
                <input type="range" id="score-font-size" min="5" max="15" value="10" step="0.5">
            </div>
            <div class="settings-group">
                <label for="timer-font-size">Timer Font Size: <span id="timer-font-size-value">14</span>rem</label>
                <input type="range" id="timer-font-size" min="6" max="20" value="14" step="0.5">
            </div>
            <div class="settings-group">
                <label>
                    <input type="checkbox" id="keep-screen-on"> Keep screen on (prevents device sleep)
                </label>
            </div>
        </div>
    </div>

    <audio id="alarm" src="audio/buzzer.mp3"></audio>

    <script>
        // Elements
        const team1Score = document.getElementById('score-team1');
        const team2Score = document.getElementById('score-team2');
        const timerDisplay = document.getElementById('timer');
        const alarm = document.getElementById('alarm');

        // Initial values
        let team1Points = 0;
        let team2Points = 0;
        let timerRunning = false;
        let timerInterval;
        let timeLeft = 15 * 60; // 10 minutes in seconds
        let periodScores = [];
        let wakeLock = null;

        // Format time as MM:SS
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Initialize timer display
        timerDisplay.textContent = formatTime(timeLeft);

        // Timer logic
        function startStopTimer() {
            if (timerRunning) {
                // Stop timer
                clearInterval(timerInterval);
                timerRunning = false;
            } else {
                // Start timer
                timerRunning = true;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = formatTime(timeLeft);

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        timerRunning = false;

                        // Capture the current score
                        captureScore();

                        // Play alarm and reset timer
                        playAlarm();

                        // Reset timer to configured time
                        timeLeft = parseInt(timerMinutesInput.value) * 60;
                        timerDisplay.textContent = formatTime(timeLeft);
                    }
                }, 1000);
            }
        }

        // Function to capture the score at the end of a period
        function captureScore() {
            // Add current score to the period scores array
            periodScores.push(`${team1Points} - ${team2Points}`);

            // Update the score history display
            updateScoreHistory();
        }

        // Function to update the score history display
        function updateScoreHistory() {
            const scoreHistoryElement = document.getElementById('score-history');
            scoreHistoryElement.innerHTML = '';

            // Display each period score
            periodScores.forEach((score, index) => {
                const periodElement = document.createElement('span');
                periodElement.className = 'period-score';
                periodElement.textContent = score;
                periodElement.contentEditable = 'true';
                scoreHistoryElement.appendChild(periodElement);
            });
        }

        // Play alarm sound
        function playAlarm() {
            alarm.play();
            timerDisplay.style.backgroundColor = '#f00';
            setTimeout(() => {
                timerDisplay.style.backgroundColor = '#333';
            }, 500);
        }

        // Reset timer (double tap)
        let lastTap = 0;
        function handleTimerTap() {
            const now = new Date().getTime();
            const timeSince = now - lastTap;

            if (timeSince < 300 && timeSince > 0) {
                // Double tap - reset timer
                clearInterval(timerInterval);
                timerRunning = false;
                timeLeft = parseInt(timerMinutesInput.value) * 60;
                timerDisplay.textContent = formatTime(timeLeft);
                timerDisplay.style.backgroundColor = '#333';
            } else {
                // Single tap - start/stop
                startStopTimer();
            }

            lastTap = now;
        }

        // Event Listeners
        team1Score.addEventListener('click', () => {
            team1Points++;
            team1Score.textContent = team1Points;
        });

        team2Score.addEventListener('click', () => {
            team2Points++;
            team2Score.textContent = team2Points;
        });

        timerDisplay.addEventListener('click', handleTimerTap);

        // Font size adjustment functions
        function updateScoreFontSize(value) {
            const scoreElements = document.querySelectorAll('.score');
            scoreElements.forEach(el => {
                el.style.fontSize = `${value}rem`;
            });
            document.getElementById('score-font-size-value').textContent = value;
            localStorage.setItem('scoreFontSize', value);
        }

        function updateTimerFontSize(value) {
            timerDisplay.style.fontSize = `${value}rem`;
            document.getElementById('timer-font-size-value').textContent = value;
            localStorage.setItem('timerFontSize', value);
        }

        let pressTimer;

        team1Score.addEventListener('touchstart', function () {
            pressTimer = window.setTimeout(() => {
                if (team1Points > 0) {
                    team1Points--;
                    team1Score.textContent = team1Points;
                }
            }, 800);
        });

        team2Score.addEventListener('touchstart', function () {
            pressTimer = window.setTimeout(() => {
                if (team2Points > 0) {
                    team2Points--;
                    team2Score.textContent = team2Points;
                }
            }, 800);
        });

        // Clear the timeout if the user lifts their finger
        team1Score.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
        });

        team2Score.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
        });

        // Add keyboard support for desktop testing
        document.addEventListener('keydown', (e) => {
            if (e.key === 'h') {
                team1Points++;
                team1Score.textContent = team1Points;
            } else if (e.key === 'a') {
                team2Points++;
                team2Score.textContent = team2Points;
            } else if (e.key === ' ') {
                startStopTimer();
            } else if (e.key === 'r') {
                clearInterval(timerInterval);
                timerRunning = false;
                timeLeft = 10 * 60;
                timerDisplay.textContent = formatTime(timeLeft);
            } else if (e.key === 'f') {
                toggleFullscreen();
            }
        });

        // Settings and Fullscreen functionality
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const setTimerBtn = document.getElementById('set-timer-btn');
        const timerMinutesInput = document.getElementById('timer-minutes');
        const team1NameInput = document.getElementById('team1-name');
        const team2NameInput = document.getElementById('team2-name');
        const setTeamBtn = document.getElementById('set-team-btn');
        const resetScoresBtn = document.getElementById('reset-scores-btn');
        const resetHistoryBtn = document.getElementById('reset-history-btn');
        const testBuzzerBtn = document.getElementById('test-buzzer-btn');
        const team1NameElement = document.querySelector('.team:nth-of-type(1) .team-name');
        const team2NameElement = document.querySelector('.team:nth-of-type(2) .team-name');
        const scoreFontSizeSlider = document.getElementById('score-font-size');
        const timerFontSizeSlider = document.getElementById('timer-font-size');
        const keepScreenOnCheckbox = document.getElementById('keep-screen-on');

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Enter fullscreen
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) { /* IE11 */
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE11 */
                    document.msExitFullscreen();
                }
            }
        }

        function toggleSettings() {
            console.log("toggling");
            settingsPanel.classList.toggle('active');
        }

        function setTimer() {
            const minutes = parseInt(timerMinutesInput.value);
            if (minutes > 0 && minutes <= 60) {
                clearInterval(timerInterval);
                timerRunning = false;
                timeLeft = minutes * 60;
                timerDisplay.textContent = formatTime(timeLeft);
                timerDisplay.style.backgroundColor = '#333';
            }
        }

        function resetScoreHistory() {
            periodScores = [];
            updateScoreHistory();
        }

        function setTeamName() {
            team1NameElement.textContent = team1NameInput.value;
            team2NameElement.textContent = team2NameInput.value;
        }

        function resetScores() {
            team1Points = 0;
            team2Points = 0;
            team1Score.textContent = team1Points;
            team2Score.textContent = team2Points;
        }

        // Initialize settings inputs with current values
        team1NameInput.value = team1NameElement.textContent;
        team2NameInput.value = team2NameElement.textContent;
        timerMinutesInput.value = Math.floor(timeLeft / 60);

        // Load saved font sizes if available
        if (localStorage.getItem('scoreFontSize')) {
            const savedScoreFontSize = localStorage.getItem('scoreFontSize');
            scoreFontSizeSlider.value = savedScoreFontSize;
            updateScoreFontSize(savedScoreFontSize);
        }

        if (localStorage.getItem('timerFontSize')) {
            const savedTimerFontSize = localStorage.getItem('timerFontSize');
            timerFontSizeSlider.value = savedTimerFontSize;
            updateTimerFontSize(savedTimerFontSize);
        }

        // Load saved screen wake lock preference
        if (localStorage.getItem('keepScreenOn') === 'true') {
            keepScreenOnCheckbox.checked = true;
            requestWakeLock();
        }

        // Event listeners for settings
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        settingsBtn.addEventListener('click', toggleSettings);
        setTimerBtn.addEventListener('click', setTimer);
        setTeamBtn.addEventListener('click', setTeamName);
        resetScoresBtn.addEventListener('click', resetScores);
        resetHistoryBtn.addEventListener('click', resetScoreHistory);
        testBuzzerBtn.addEventListener('click', playAlarm);
        keepScreenOnCheckbox.addEventListener('change', toggleWakeLock);

        // Font size slider event listeners
        scoreFontSizeSlider.addEventListener('input', (e) => {
            updateScoreFontSize(e.target.value);
        });

        timerFontSizeSlider.addEventListener('input', (e) => {
            updateTimerFontSize(e.target.value);
        });

        // Close settings panel when clicking outside
        document.addEventListener('click', (e) => {
            if (!settingsPanel.contains(e.target) && e.target !== settingsBtn && !settingsBtn.contains(e.target)) {
                settingsPanel.classList.remove('active');
            }
        });

        // Wake Lock API to prevent screen from turning off
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock is active');

                    // Listen for visibility changes to reacquire wake lock if needed
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                } catch (err) {
                    console.error(`Failed to get wake lock: ${err.message}`);
                }
            } else {
                console.warn('Wake Lock API not supported in this browser');
                alert('Keep screen on feature is not supported in your browser');
                keepScreenOnCheckbox.checked = false;
            }
        }

        // Release the wake lock when no longer needed
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release()
                    .then(() => {
                        console.log('Wake Lock has been released');
                        wakeLock = null;
                    });
                document.removeEventListener('visibilitychange', handleVisibilityChange);
            }
        }

        // Handle visibility changes (when user switches tabs/apps)
        function handleVisibilityChange() {
            if (document.visibilityState === 'visible' && keepScreenOnCheckbox.checked) {
                requestWakeLock();
            }
        }

        // Toggle wake lock based on checkbox
        function toggleWakeLock() {
            if (keepScreenOnCheckbox.checked) {
                requestWakeLock();
                localStorage.setItem('keepScreenOn', 'true');
            } else {
                releaseWakeLock();
                localStorage.setItem('keepScreenOn', 'false');
            }
        }
    </script>
</body>
</html>
