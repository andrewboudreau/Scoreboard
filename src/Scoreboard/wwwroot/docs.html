<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard — Documentation</title>

    <!-- highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>

    <!-- marked.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>

    <!-- mermaid -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script>

    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            color: #e0e0e0;
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        /* ── Sidebar ── */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: #111;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 20px 0;
            z-index: 10;
        }

        nav .nav-title {
            padding: 0 20px 16px;
            font-size: 15px;
            font-weight: 700;
            color: #69db7c;
            border-bottom: 1px solid #333;
            margin-bottom: 12px;
        }

        nav a {
            display: block;
            padding: 6px 20px;
            color: #aaa;
            text-decoration: none;
            font-size: 13px;
            transition: color 0.15s, background 0.15s;
        }

        nav a:hover, nav a.active {
            color: #69db7c;
            background: #1a1a1a;
        }

        nav a.sub {
            padding-left: 36px;
            font-size: 12px;
            color: #777;
        }

        nav a.sub:hover, nav a.sub.active {
            color: #69db7c;
        }

        /* ── Main content ── */
        main {
            margin-left: 260px;
            flex: 1;
            max-width: 900px;
            padding: 40px 48px 80px;
        }

        /* ── Typography ── */
        h1 { font-size: 28px; color: #69db7c; margin: 0 0 8px; }
        h2 { font-size: 22px; color: #69db7c; margin: 48px 0 16px; padding-bottom: 6px; border-bottom: 1px solid #333; }
        h3 { font-size: 17px; color: #ccc; margin: 32px 0 12px; }
        h4 { font-size: 14px; color: #aaa; margin: 24px 0 8px; }
        p { margin: 0 0 12px; }
        ul, ol { margin: 0 0 12px; padding-left: 24px; }
        li { margin-bottom: 4px; }
        strong { color: #fff; }
        code { background: #1e1e1e; padding: 2px 6px; border-radius: 3px; font-size: 13px; color: #69db7c; }
        a { color: #69db7c; }

        pre {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 0 0 16px;
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        /* ── Tables ── */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 0 16px;
            font-size: 13px;
        }

        th, td {
            text-align: left;
            padding: 8px 12px;
            border: 1px solid #333;
        }

        th { background: #1a1a1a; color: #69db7c; font-weight: 600; }
        td { background: #111; }

        /* ── Mermaid ── */
        .mermaid {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 20px;
            margin: 0 0 16px;
            text-align: center;
        }

        /* ── Blockquotes ── */
        blockquote {
            border-left: 3px solid #69db7c;
            padding: 8px 16px;
            margin: 0 0 16px;
            background: #0d1f0d;
            border-radius: 0 6px 6px 0;
        }

        blockquote p:last-child { margin-bottom: 0; }

        /* ── Mobile ── */
        @media (max-width: 860px) {
            nav { display: none; }
            main { margin-left: 0; padding: 24px 20px 60px; }
        }
    </style>
</head>
<body>
    <nav id="sidebar"></nav>
    <main id="content"></main>

    <script id="doc-source" type="text/template">
# Scoreboard Documentation

A basketball scoreboard single-page app packaged as a WebModule (`SharedTools.Scoreboard`). The frontend runs a **game instance** — a self-contained unit of scores, rosters, timers, and event logs stored in a single consolidated file. The backend's primary job is acting as a **key dispenser** for Azure Blob Storage and creating shareable game result links; it stays out of the live data path.

## System Overview

### Architecture

```mermaid
graph LR
    Host["ASP.NET Host"] -->|loads| Module["Scoreboard Module"]
    Module -->|serves| SPA["SPA (app.js)"]
    SPA -->|GET /api/groups/join| API["Server API"]
    API -->|returns SAS URLs| SPA
    SPA -->|direct PUT/GET via SAS| Blob["Azure Blob Storage"]
    SPA -->|POST /api/games/share| API
    API -->|reads game blob| Blob
    Viewer -->|GET /api/shares/CODE| API
```

The host loads `SharedTools.Scoreboard` as a NuGet-packaged WebModule. The SPA is served as an embedded resource at `/Scoreboard/`. Game state flows through two paths:

1. **localStorage** — immediate, every change (offline-first source of truth)
2. **Direct-to-Blob** — SPA writes a consolidated game file via SAS URLs (5s debounce, fire-and-forget)

The server never sits in the hot path during a game. It creates groups, dispenses SAS tokens, and facilitates shareable game result links.

### Module Contract

The module implements `IApplicationPartModule`:

- **ConfigureServices** — registers `BlobContainerClient`, `IDefaultPlayersService`, `IGroupService`, `IGameShareService`
- **Configure** — maps all routes under `/Scoreboard/` prefix
- **Static assets** — embedded in the DLL under `wwwroot/`, served at `/_content/Scoreboard/`

## Components

### Class Diagram

```mermaid
graph TD
    App["ScoreboardApp"] --> Timer
    App --> Teams
    App --> Players
    App --> Settings
    App --> UI
    App --> BlobSync
    App --> SyncManager
    SyncManager --> BlobSync
```

`ScoreboardApp` is the central orchestrator. It owns the game instance and all component references. Components operate on the shared app state.

### Component Reference

| Class | Role | Key State | Key Methods |
|-------|------|-----------|-------------|
| **ScoreboardApp** | Orchestrator, owns game instance | `periodScores[]`, `events[]`, `playersList[]`, `currentShareCode` | `recordScoreChange()`, `captureScore()`, `syncGame()`, `shareGame()` |
| **Timer** | Countdown clock | `timeLeft`, `isRunning`, `lastTap` | `startStop()`, `reset()`, `handleTimerTap()`, `playAlarm()` |
| **Teams** | Score and name tracking | `team1Points`, `team2Points` | `incrementScore()`, `decrementScore()`, `setTeamNames()` |
| **Players** | Roster management | (uses `app.playersList`) | `addPlayer()`, `incrementPlayerPoints()`, `updatePlayersDisplay()` |
| **Settings** | Configuration panel | (DOM element refs) | `toggle()`, `updateGroupUI()`, `handleJoinGroup()`, `handleCreateGroup()` |
| **UI** | Display updates | (DOM element refs) | `toggleFullscreen()`, `updateScoreHistory()`, `updateScoreFontSize()` |
| **BlobSync** | Azure Blob I/O + group state | `groupId`, `readUrl`, `writeUrl`, `code` | `join()`, `upload()`, `download()`, `debouncedUpload()` |
| **SyncManager** | Reliable online/offline sync | `dirty` | `shouldSync()`, `markDirty()`, `markClean()` |

## Scoreboard Engine

### Game Instance

A game instance is the core data unit stored as a single consolidated JSON file. It contains:

- Two teams with names and scores
- A player roster with per-player points
- Timer configuration (minutes per period)
- Period scores array (captured on timer expiry)
- An event log of every score change and period end
- An optional share code for public result links

Top-level fields are cached derived state (for fast load). The events array is the audit trail.

The frontend runs whatever game instance it's given. When connected to a group, the instance syncs to Azure Blob Storage so multiple devices see the same state.

### Timer

The timer counts down from a configurable duration (1–60 minutes, default 15).

**Interaction:**
- **Tap** — start or stop the countdown
- **Double-tap** (within 300ms) — reset to configured duration
- Detection via timestamp comparison in `handleTimerTap()`

**On expiry (timeLeft reaches 0):**
1. Stop the interval
2. Capture the period score (`"team1Score - team2Score"` string pushed to `periodScores[]`)
3. Append a `period_end` event
4. Play the buzzer audio
5. Blink the timer background red 5 times at 250ms intervals
6. Auto-reset to the configured duration

### Scoring

**Team scores:**
- **Click** the score display → increment by 1
- **Long-press** (800ms touch) → decrement by 1 (floor at 0)

**Player scoring:**
- Click a player name in the on-screen team list → increments both the player's individual points **and** their team's score
- In the Players panel table: **+/−** buttons adjust player points and team score together

Every score change calls `app.recordScoreChange(teamNumber, isIncrement, playerName)` which appends a `score` event and triggers both persistence paths (localStorage + blob sync).

### Periods

The `periodScores[]` array stores period-ending snapshots as strings like `"24 - 18"`.

- Captured automatically when the timer expires
- A `period_end` event is appended to the events log
- Displayed below the timer as clickable spans
- **Click a period score** to replace it with the current team scores (calls `correctPeriodScore(index)`)
- Period correction also updates the matching `period_end` event's scores and syncs to blob
- Included in the consolidated game file synced to blob
- "Reset History" in Settings clears both `periodScores` and `events`

## Events & Data Flow

### Score Change Sequence

```mermaid
sequenceDiagram
    participant User
    participant Teams/Players
    participant App as ScoreboardApp
    participant LS as localStorage
    participant Blob as Azure Blob (direct)

    User->>Teams/Players: Click score / player
    Teams/Players->>App: recordScoreChange()
    App->>LS: Save gameEvents (immediate)
    App->>Blob: debouncedUpload consolidated game (5s)
```

### Upload Paths

| Path | Target | Trigger | Debounce |
|------|--------|---------|----------|
| **localStorage** | Browser (`gameEvents`) | Every score/period event | None (immediate) |
| **BlobSync** | `games/{gameId}.json` | Every score/period event | 5 seconds |

One consolidated file per game — state + events together. No separate event log file, no server-side upload.

### Event Shapes

**Score event:**

```json
{
  "ts": "2026-02-01T15:45:30.000Z",
  "type": "score",
  "team": 1,
  "player": "Alice",
  "action": "increment",
  "scores": [42, 38],
  "timer": 450
}
```

`player` is `null` when the team score element is clicked directly (not via a player).

**Period end event:**

```json
{
  "ts": "2026-02-01T16:00:00.000Z",
  "type": "period_end",
  "scores": [24, 18],
  "period": 1
}
```

## UI Features

### Main View

The scoreboard layout from top to bottom:

- **Scores row** — large clickable score displays with team names (`contentEditable`) above them. Player lists flank the scores on each side.
- **Timer** — large countdown display below the scores. Tap to start/stop, double-tap to reset.
- **Period history** — row of editable period score spans below the timer.
- **Control buttons** — fixed bottom-right: Players, Settings, Fullscreen.

### Side Panels

Two 510px-wide panels toggle from the control buttons. Clicking outside an open panel closes it.

**Players panel:**
- Management table with columns: Name, Team (select), Active (checkbox), Points (+/−), Remove (X)
- Add player input with Enter key support
- Export (clipboard), Import (paste JSON), Load Defaults buttons

**Settings panel:**
- Timer duration input (1–60 minutes) with Set Timer button
- Team name inputs (synced bidirectionally with main display)
- Score decrement (−1) buttons per team
- Reset Scores, Reset History, Test Buzzer, Test Timer End buttons
- Score font size slider (5–15 rem)
- Timer font size slider (6–20 rem)
- Keep Screen On checkbox (Wake Lock API)
- Group management section (join/create/share group link/share game results/leave)
- Manage Default Players link

### Shareable Game Results

When connected to a group, the "Share Game Results" button creates a public link via the server (`POST /api/games/share`). The server stores a mapping from an 8-character share code to the game blob path. The resulting URL points to a read-only results page at `/Scoreboard/game?s={code}`.

The results page (`game.html`) is self-contained — no BlobSync, no localStorage, no authentication. It fetches game data from `/Scoreboard/api/shares/{code}` (which reads the blob server-side) and renders:
- Final score with winner highlighting
- Period breakdown table
- Player stats sorted by points
- Chronological event timeline

### Stats / Game History Page

A standalone page at \`/Scoreboard/stats\` that shows all past games for the connected group:

- **Bootstrap** — reads \`groupCode\` from localStorage, calls \`/api/groups/join\` to get SAS URLs. If no code, shows a connect prompt.
- **List games** — uses the Azure Blob List API via the read SAS URL to enumerate all game files under \`{groupId}/games/\`.
- **List view** — cards for each game showing date, team names, and final score. Sorted newest first.
- **Detail view** — click a game card to see final score, period breakdown, player stats, and event timeline. Uses the same rendering approach as \`game.html\`.

The stats page is self-contained (no dependency on \`app.js\`). All CSS and JS are inline in \`stats.html\`.

### Fullscreen & Wake Lock

- **Fullscreen** — cross-browser toggle via `requestFullscreen` API
- **Wake Lock** — prevents device sleep via `navigator.wakeLock`. Re-acquired on visibility change. Persisted to localStorage.
- **Font sizes** — persisted to localStorage, applied on load

## Storage

### localStorage Keys

| Key | Type | Description |
|-----|------|-------------|
| `groupCode` | string | Current group code for auto-rejoin |
| `gameEvents` | JSON array | Score and period event log |
| `scoreFontSize` | string | Score display font size in rem |
| `timerFontSize` | string | Timer display font size in rem |
| `keepScreenOn` | `"true"` / `"false"` | Wake lock preference |
| `playersList` | JSON array | Current player roster |

> **Migration:** On first load, the old `scoreHistory` key is automatically migrated to `gameEvents`. The legacy `lastUploadAttempt` key is removed.

### Azure Blob Layout

```text
container/
├── _groups/{groupId}.json              # Group metadata (server-managed)
├── _shares/{code}.json                 # Share code → game mapping (server-managed)
├── {groupId}/
│   ├── roster.json                     # Player roster
│   └── games/{gameId}.json             # Consolidated game state + events
```

**Consolidated game file** (`games/{gameId}.json`):

```json
{
  "id": "game-2026-02-01",
  "version": 1,
  "weekDate": "2026-02-01",
  "team1": { "name": "BLACK", "score": 42 },
  "team2": { "name": "WHITE", "score": 38 },
  "period": 3,
  "periodScores": ["24 - 18", "18 - 20"],
  "timerMinutes": 15,
  "players": [{ "id": 1742075931014, "name": "Andrew", "team": "1", "active": true, "points": 7 }],
  "events": [
    { "ts": "2026-02-01T15:45:30.000Z", "type": "score", "team": 1, "player": "Andrew", "action": "increment", "scores": [42, 38], "timer": 450 },
    { "ts": "2026-02-01T16:00:00.000Z", "type": "period_end", "scores": [24, 18], "period": 1 }
  ],
  "shareCode": null,
  "lastUpdated": "2026-02-01T16:30:00.000Z"
}
```

**Share mapping** (`_shares/{code}.json`):

```json
{
  "code": "X7K2M9PQ",
  "groupId": "uuid",
  "gameId": "game-2026-02-01",
  "createdAt": "2026-02-01T17:00:00Z"
}
```

### Sync Behavior

`BlobSync.debouncedUpload(path, data, delayMs)` uses path-keyed timeouts — each blob path gets its own debounce timer. If a new change arrives before the timer fires, it resets.

On **403** responses (expired SAS), BlobSync automatically calls `_refreshSas()` to get new tokens from the server, then retries the original operation once.

Blob sync is fire-and-forget — scoring and timer never depend on network connectivity. localStorage is always the source of truth.

### SyncManager (Reliable Sync)

`SyncManager` sits between `BlobSync` and `ScoreboardApp` to handle connectivity gracefully:

- **Online/offline detection** — uses `navigator.onLine` and `online`/`offline` events
- **Guard syncGame()** — checks `syncManager.shouldSync()` before blob upload; if offline, marks dirty and skips
- **Periodic sync** — 2-minute interval calls `syncGame()` when online and connected
- **Reconnect flush** — `online` event fires → immediately syncs if dirty
- **Visibility flush** — tab becomes visible → syncs if dirty and online

localStorage always saves immediately regardless of online state. The `dirty` flag tracks whether unsynced changes exist.

## Groups & Sharing

### Concept

Groups are access containers for shared scoreboard state. A group has:

- One **admin code** (8-char uppercase) — full control
- Multiple **member codes** (6-char lowercase) — read/write game data

The code is your key. Enter it to get SAS tokens for direct blob access.

### Code Charsets

| Type | Length | Characters | Excluded |
|------|--------|------------|----------|
| Admin | 8 | `ABCDEFGHJKLMNPQRSTUVWXYZ23456789` | I, O, 0, 1 |
| Member | 6 | `abcdefghjkmnpqrstuvwxyz23456789` | i, l, o, 0, 1 |
| Share | 8 | `ABCDEFGHJKLMNPQRSTUVWXYZ23456789` | I, O, 0, 1 |

Ambiguous characters are excluded to prevent confusion when sharing codes verbally.

### Flow

```mermaid
sequenceDiagram
    participant Admin
    participant Server
    participant Blob as Azure Blob
    participant Member

    Admin->>Server: POST /api/groups {name}
    Server-->>Admin: {groupId, adminCode}
    Admin->>Server: GET /api/groups/join?code=ADMINCODE
    Server-->>Admin: {groupId, sasUrls}
    Admin->>Blob: Upload roster, game state

    Admin->>Server: POST /api/groups/{id}/members {label}
    Server-->>Admin: {memberCode}
    Admin-->>Member: Share link with code

    Member->>Server: GET /api/groups/join?code=membercode
    Server-->>Member: {groupId, sasUrls}
    Member->>Blob: Read/write game state directly
```

### Share Game Results Flow

```mermaid
sequenceDiagram
    participant User
    participant Server
    participant Blob as Azure Blob
    participant Viewer

    User->>Blob: Upload latest game state
    User->>Server: POST /api/games/share {groupId, gameId}
    Server->>Blob: Write _shares/{code}.json
    Server-->>User: {shareCode, shareUrl}
    User-->>Viewer: Share URL

    Viewer->>Server: GET /api/shares/{code}
    Server->>Blob: Read _shares/{code}.json
    Server->>Blob: Read {groupId}/games/{gameId}.json
    Server-->>Viewer: Game JSON
    Viewer->>Viewer: Render read-only results page
```

### Auto-Join

On page load, the SPA checks for a group code in this order:
1. URL query parameter `?code=XXX`
2. URL hash `#XXX`
3. localStorage `groupCode`

If found, it automatically joins and loads group data (roster, active game).

### SAS Tokens

- **Expiry**: 3 hours from generation
- **Permissions**: Read + List always; Write + Create for all members (admin and member codes both get write access)
- **Refresh**: Transparent — on 403, BlobSync calls `/api/groups/{id}/sas/refresh?code=X` and retries

### Permissions

- **Admin**: create group, add/revoke members, read/write all data
- **Members**: read/write game data, cannot manage membership

## API Reference

### POST `/Scoreboard/api/groups`

Create a new group.

**Request body:**
```json
{ "name": "Friday Hoops" }
```

**Response (201):**
```json
{
  "groupId": "uuid",
  "name": "Friday Hoops",
  "adminCode": "ABC2DEFG"
}
```

**Errors:** `400` — name is required

---

### GET `/Scoreboard/api/groups/join?code=X`

Join a group using an admin or member code. Returns SAS URLs for direct blob access.

**Response (200):**
```json
{
  "groupId": "uuid",
  "groupName": "Friday Hoops",
  "isAdmin": true,
  "sasUrls": {
    "readUrl": "https://...?sv=...&sig=...",
    "writeUrl": "https://...?sv=...&sig=..."
  }
}
```

**Errors:** `400` — code required, `404` — invalid code

---

### POST `/Scoreboard/api/groups/{id}/members?adminCode=X`

Add a member to a group (admin only).

**Request body:**
```json
{ "label": "Player 1" }
```

**Response (201):**
```json
{ "code": "abc2de", "label": "Player 1" }
```

**Errors:** `400` — admin code or label required, `403` — invalid admin code, `404` — group not found

---

### DELETE `/Scoreboard/api/groups/{id}/members/{code}?adminCode=X`

Revoke a member's access (admin only).

**Response:** `204` No Content

**Errors:** `400` — admin code required, `403` — invalid admin code, `404` — group or member not found

---

### GET `/Scoreboard/api/groups/{id}/sas/refresh?code=X`

Refresh SAS tokens. Works with both admin and member codes.

**Response (200):**
```json
{
  "readUrl": "https://...?sv=...&sig=...",
  "writeUrl": "https://...?sv=...&sig=..."
}
```

**Errors:** `400` — code required, `403` — invalid code, `404` — group not found

---

### POST `/Scoreboard/api/games/share`

Create a shareable link for a game. Stores a mapping blob at `_shares/{code}.json`.

**Request body:**
```json
{ "groupId": "uuid", "gameId": "game-2026-02-01" }
```

**Response (200):**
```json
{
  "shareCode": "X7K2M9PQ",
  "shareUrl": "/Scoreboard/game?s=X7K2M9PQ"
}
```

**Errors:** `400` — groupId and gameId required

---

### GET `/Scoreboard/api/shares/{code}`

Retrieve shared game data. No authentication required — reads the game blob via the server's storage client.

**Response (200):** Full consolidated game JSON (same shape as the blob file).

**Errors:** `404` — share code not found or game data not found

---

### GET `/Scoreboard/api/default-players`

Get the default player roster.

**Response (200):** Array of player objects:
```json
[
  { "id": 1742075931014, "name": "Alice", "team": "1", "active": true, "points": 0 }
]
```
    </script>

    <script>
        // ── Mermaid init ──
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#1a3a1a',
                primaryTextColor: '#e0e0e0',
                primaryBorderColor: '#69db7c',
                lineColor: '#69db7c',
                secondaryColor: '#1e1e1e',
                tertiaryColor: '#111',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'
            }
        });

        // ── Custom marked renderer ──
        marked.use({
            gfm: true,
            breaks: false,
            renderer: {
                code(text, lang) {
                    text = text || '';
                    lang = lang || '';
                    if (lang === 'mermaid') {
                        return `<div class="mermaid">${text}</div>`;
                    }
                    const highlighted = lang && hljs.getLanguage(lang)
                        ? hljs.highlight(text, { language: lang }).value
                        : hljs.highlightAuto(text).value;
                    return `<pre><code class="hljs language-${lang}">${highlighted}</code></pre>`;
                },
                heading(text, level) {
                    text = text || '';
                    const id = text.replace(/<[^>]+>/g, '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
                    return `<h${level} id="${id}">${text}</h${level}>`;
                }
            }
        });

        // ── Render content ──
        const md = document.getElementById('doc-source').textContent;
        document.getElementById('content').innerHTML = marked.parse(md);

        // ── Build sidebar from headings ──
        const sidebar = document.getElementById('sidebar');
        const headings = document.querySelectorAll('main h1, main h2, main h3');
        let navHtml = '<div class="nav-title">Scoreboard Docs</div>';

        headings.forEach(h => {
            const level = parseInt(h.tagName[1]);
            if (level === 1) return; // skip the page title
            const cls = level === 3 ? ' class="sub"' : '';
            navHtml += `<a href="#${h.id}"${cls}>${h.textContent}</a>`;
        });

        sidebar.innerHTML = navHtml;

        // ── Highlight active nav on scroll ──
        const navLinks = sidebar.querySelectorAll('a');
        const headingEls = Array.from(headings).filter(h => h.tagName !== 'H1');

        function updateActive() {
            let current = '';
            for (const h of headingEls) {
                if (h.getBoundingClientRect().top <= 80) current = h.id;
            }
            navLinks.forEach(a => {
                a.classList.toggle('active', a.getAttribute('href') === '#' + current);
            });
        }

        window.addEventListener('scroll', updateActive, { passive: true });
        updateActive();

        // ── Render mermaid diagrams ──
        mermaid.run({ querySelector: '.mermaid' });
    </script>
</body>
</html>
